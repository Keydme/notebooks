# PSM的简单介绍：

在因果推断中，PSM指的是倾向评分匹配（Propensity Score Matching）。它是一种常见的非实验性因果推断方法，用于减少观察数据集中存在的选择偏差或混杂变量的影响。PSM的主要目标是通过建立一个“倾向得分”来估计处理组和对照组之间的因果效应。具体来说，PSM通过预测每个个体进入处理组的概率（即倾向得分），然后根据这些得分将处理组和对照组进行配对。

  

# PSM的一般步骤包括：

估计每个个体进入处理组的概率，即倾向得分。

根据倾向得分使用一种匹配算法来创建处理组和对照组之间的匹配对。

在匹配后，可以比较处理组和对照组之间的平均效应差异，从而估计因果效应。

尽管PSM在某些情况下可以帮助控制潜在的混杂变量，但它仍然**依赖于某些假设**，例如倾向得分模型的正确规范和匹配过程的有效性。**因此，在使用PSM时需要小心，并结合其他方法进行敏感性分析以确保结果的可靠性。**

### 业务字段
OPTUM_LAB_ID：用户id，这里为便于后续使用改成了python包的字段要求

CASE：是否上了策略，即是否是实验组

aht：[ab实验](https://zhida.zhihu.com/search?content_id=235936017&content_type=Article&match_order=1&q=ab%E5%AE%9E%E9%AA%8C&zhida_source=entity)需要优化的平均操作时间
其余字段：都是一些业务字段，比如总工作天数，实验期间的各类型的任务处理量等


### 接受处理人群的平均处理效应ATT（Average Treatment Effect on the Treated）
$$ATT = E[Y_1-Y_0|P=1]$$
### 平均处理效应ATE（Average Treatment Effect）
$$ATE = E(Y(1))-E(Y(0))$$
### 精确匹配
### 评分倾向匹配（PSM）（propensity_score_matching）
#### CommonSupport
共同支撑是指在统计分析中，特别是使用倾向评分匹配（PSM）方法时，所有参与者和未参与者的倾向评分都必须位于一个重叠的范围内。这个范围内的个体才能找到合适的匹配对象，即存在共同支撑。超出这个范围的个体则无法进行有效的匹配。
同时可近似的稍微放宽条件，以求得更多样本

### 双重差分（did）
#### 截面量估计
考虑一个给农民发放贷款的项目，农民可以用得到的贷款来购买肥料从而增加他们种植的作物产量。假设我们只观察到了项目开始一年以后的数据：收到贷款的农民平均每公顷收获 1,100 公斤作物，没有收到贷款的农民平均每公顷收获 1,000 公斤作物。此时截面估计量为两者之差：1100−1000=100 1100-1000=100公斤/公顷。
截面估计量假设了**收到贷款的农民与没有收到贷款的农民拥有相同的生产率**。但是如果（1）生产率更高的农民更容易获得贷款（他们的偿还能力更强）；或（2）拥有更贫瘠土地的农民更有可能申请贷款（他们需要更多肥料来弥补土地的不足），那么这一假设就很容易被打破。
#### 前－后估计量
考虑同样的项目，收到贷款的农民在项目开始前平均每公顷收获 1,000 公斤作物，项目开始后一年，每公顷平均收成增长到了 1,200 公斤。此时前－后估计量为两者之差：1200−1000=2001200-1000=200公斤/公顷。
问题是，那些与项目本身无关的前－后改变也可能会被错误地包含进估计值之中。

#### 双重差分估计量
为了解决上述问题，我们可以构造一个新的估计量，这个估计量控制了个体的特征，并且通过比较参与者（对照组）与未参与者（实验组）在项目实施前与实施后相应的结果改变，从而试图衡量项目的参与效应。下图便展示了一个最基本的两期 DID 原理：
![[../img/v2-9b2c2a9d4398e22469497412d12ee2c5_720w.webp]]

# 客户数据字段与需求
研究方向: **确定对外直接投资与企业创新之间的因果关系**

### 数据表

原始：lprod,klratio,size,age,profit,expshare,finance,state,affiliation,**innovinten**

| 表名           | 生成方式                                         | 类型    |
| ------------ | -------------------------------------------- | ----- |
| index        | 暂无                                           | int   |
| Unnamed__0   | 暂无                                           | int   |
| OPTUM_LAB_ID | 暂无                                           | str   |
| sum_非数字专利    | 查表求和                                         | float |
| sum_数字专利     | 同上                                           | int   |
| event        | 有无重要节点？？？                                    | {0,1} |
| event_all    | 节点次数？                                        | {0,1} |
| sum_export   | 出口额（大概率取过对数）                                 | float |
| sum_import   | 进口额同上                                        | float |
| CASE         | 倾向得分（大概）                                     | 0-9   |
| lprod        | 劳动生产率（对数）（lprod=ln(工业总产额/从业人数+1)）            | float |
| klratio      | 资本密集度（对数）（klratio=ln(固定资产合计/cyrs+1)）         | float |
| size         | 企业规模（对数）（ln(企业销售额+1)）                        | float |
| age          | 企业年龄(对数)(ln(year(date(核准日期, "MDY"))-企业成立年份)) | float |
| age2         | $age^2$                                      | float |
| profit       | 企业利润率=营业利润/企业销售额                             | float |
| expshare     | 出口密集度=出口交货值/企业销售额                            | float |
| state        | 所有制结构=国家资本/实收资本                              | float |

### 处理组企业的平均处理效应

利用实验对照法思想
处理组(OFDI)（t期开始对外投资）（t+s期时的）创新量-对照组(NOFDI)（t+s期时的）创新量
$$\delta=E(IN^1_{i,t+s}-IN^0_{i,t+s}|\Omega_1)=E(IN^1_{i,t+s}|\Omega_1)-E(IN^0_{i,t+s}|\Omega_1)$$
由于$E(IN^0_{i,t+s}|\Omega_1)$难求，故利用PSM匹配使得$E(IN^0_{i,t+s}|\Omega_0)$可以近似。

### 确定企业对外直接投资的决策概率

利用logit方法估计
$$p(OFDI_{it}=1)=\Phi(LPROD,\dots，INNOVINTEN) $$
其中p为倾向得分，按p值接近程度进行配对
潜在条件：
 - 条件独立性假设（CIA）
 - 重叠条件（有大部分的∩（11对应））

至此可将上式优化为
$$\delta=\frac{1}{n}\Sigma_{i\in\Omega_1}(IN_{i,t+s}-\Sigma_{i\in\Omega_0}g(\hat p_i,\hat p_j)IN_{j,t+s}) $$
核匹配方法的权重函数表达式
$$g(\hat p_i,\hat p_j)=G(\frac{\hat p_i-\hat p_j}{h})/\Sigma_{i\in\Omega_0}G(\frac{\hat p_i-\hat p_k}{h}) $$
其中，$G(\mu)\propto exp(-\frac{\mu^2}{2})$,h为带宽参数。

### 利用did提高估计效率

$$\delta=\frac{1}{n}\Sigma_{i\in\Omega_1}(\Delta IN_{i,t+s}-\Sigma_{i\in\Omega_0}g(\hat p_i,\hat p_j)\Delta IN_{j,t+s}) $$
其中，$\Delta IN_{k,t+s}=IN_{k,t+s}-IN_{k,t+s-1},k=i,j$表示进行对外直接投资前后企业创新量的变动情况 。

**由于仅对外直接投资后由非转型成创新型有意义，故主要以标准PSM进行估计因果效应**
**以PSM-DID进行稳健性分析**






